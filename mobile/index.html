<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Orion Mobile</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            text-align: center;
            margin: 0;
            padding: 0;
            width: 100vw;
            height: 100vh;
            background: #222;
            color: #fff;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            box-sizing: border-box;
        }

        .header {
            padding: 20px;
            font-size: 2em;
            margin: 0;
            border: none;
            background: #222;
            color: inherit;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
        }

        #conversation {
            position: fixed;
            top: 80px;
            bottom: 75px;
            left: 0;
            right: 0;
            overflow-y: auto;
            padding: 10px;
            border: none;
            background: transparent;
        }

        .input-container {
            padding-bottom: 15px;
            border: none;
            background: transparent;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            background-color: #222;
        }

        .input-wrapper {
            position: relative;
            width: 95%;
            margin: 0 auto;
            border: none;
            background: transparent;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        #inputField {
            flex: 1;
            padding: 12px 50px 12px 15px;
            font-size: 1em;
            border-radius: 1em;
            border: 2px solid #444;
            background: #333;
            color: #fff;
            outline: none;
            transition: border-color 0.3s ease;
            box-sizing: border-box;
            font-family: inherit;
        }

        #sendButton {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            border: none;
            background: #2B5A87;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.3s ease;
            font-size: 18px;
            flex-shrink: 0;
        }

        #sendButton:hover {
            opacity: 0.8;
        }

        #sendButton:active {
            opacity: 0.6;
        }

        #sendButton:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        #inputField:focus {
            border-color: #666;
        }

        #inputField::placeholder {
            color: #aaa;
        }

        #attachFileButton {
            position: absolute;
            right: 60px;
            top: 50%;
            transform: translateY(-50%);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            background: transparent;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.3s ease;
            padding: 0;
        }

        #attachFileButton img {
            width: 20px;
            height: 20px;
            object-fit: contain;
        }

        #attachFileButton:hover {
            opacity: 0.7;
        }

        #attachFileButton:active {
            opacity: 0.5;
        }

        /* Message styles matching the extension exactly */
        .message {
            margin: 10px;
            padding: 8px 12px;
            border-radius: 12px;
            max-width: 70%;
            word-wrap: break-word;
        }

        .message.from-PC {
            background: #2B5A87;
            color: white;
            margin-left: auto;
            margin-right: 10px;
            text-align: right;
        }

        .message.from-phone {
            background: #333;
            color: white;
            margin-left: 10px;
            margin-right: auto;
            text-align: left;
        }

        .message .timestamp {
            font-size: 0.7em;
            color: #aaa;
            margin-top: 4px;
        }

        .file-link {
            color: #4A9EFF;
            text-decoration: underline;
            cursor: pointer;
        }

        .empty-state {
            text-align: center;
            color: #aaa;
            padding: 20px;
        }
    </style>
</head>

<body>
    <div class="header">Orion</div>
    <div id="conversation"></div>
    <div class="input-container">
        <div class="input-wrapper">
            <input type="text" id="inputField" placeholder="Type here...">
            <input type="file" id="fileInput" style="display: none;">
            <button id="attachFileButton" title="Attach File">
                <img src="/imgs/attach.png" alt="ðŸ“Ž">
            </button>
            <button id="sendButton" title="Send Message">âž¤</button>
        </div>
    </div>

    <script>
        // Configuration
        const SERVER_URL = window.location.origin;
        const WS_URL = `ws://${window.location.host}/mobile/ws`;
        let isLoading = false;
        let websocket = null;
        let reconnectInterval = null;

        // DOM elements
        const conversation = document.getElementById('conversation');
        const inputField = document.getElementById('inputField');
        const attachFileButton = document.getElementById('attachFileButton');
        const fileInput = document.getElementById('fileInput');
        const sendButton = document.getElementById('sendButton');

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function () {
            console.log('Orion Mobile initialized');
            setupEventListeners();
            connectWebSocket();
        });

        function connectWebSocket() {
            console.log('Connecting to WebSocket:', WS_URL);

            try {
                websocket = new WebSocket(WS_URL);

                websocket.onopen = function (event) {
                    console.log('WebSocket connected');
                    if (reconnectInterval) {
                        clearInterval(reconnectInterval);
                        reconnectInterval = null;
                    }
                };

                websocket.onmessage = function (event) {
                    const message = JSON.parse(event.data);
                    console.log('WebSocket message received:', message);

                    if (message.type === 'initial' || message.type === 'update') {
                        displayConversation(message.data);
                    }
                };

                websocket.onclose = function (event) {
                    console.log('WebSocket disconnected, attempting to reconnect...');
                    websocket = null;

                    // Attempt to reconnect every 3 seconds
                    if (!reconnectInterval) {
                        reconnectInterval = setInterval(() => {
                            connectWebSocket();
                        }, 3000);
                    }
                };

                websocket.onerror = function (error) {
                    console.error('WebSocket error:', error);
                };
            } catch (error) {
                console.error('Failed to create WebSocket connection:', error);
                // Fallback to HTTP polling if WebSocket fails
                loadConversationHTTP();
            }
        }

        function hideLoadingIndicator() {
            // No loading indicator in the simple design
        }

        function loadConversationHTTP() {
            console.log('Loading conversation via HTTP...');

            fetch(`${SERVER_URL}/mobile/items`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                },
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Loaded conversation data:', data);
                    displayConversation(data);
                })
                .catch(error => {
                    console.error('Error loading conversation:', error);
                    displayError('Failed to load conversation');
                });
        }

        let lastMessageCount = 0;

        function displayConversation(data) {
            // Only rebuild if this is the initial load or if messages were deleted
            if (conversation.children.length === 0 || (data.items && data.items.length < lastMessageCount)) {
                // Clear existing content for fresh start
                conversation.innerHTML = '';
                lastMessageCount = 0;
            }

            // Process items if they exist
            if (data.items && data.items.length > 0) {
                // Only add new messages (skip already displayed ones)
                const newMessages = data.items.slice(lastMessageCount);

                newMessages.forEach(item => {
                    console.log(`Adding new item from ${item.from}: ${item.content} (${item.type})`);

                    // Create message element
                    const messageDiv = document.createElement('div');
                    messageDiv.className = `message from-${item.from}`;

                    // Add content based on type
                    if (item.type === 'text') {
                        // Check if content contains URLs and make them clickable
                        const urlRegex = /(https?:\/\/[^\s]+)/g;
                        if (urlRegex.test(item.content)) {
                            // Content has URLs, replace with clickable links
                            const htmlContent = item.content.replace(urlRegex, '<a href="$1" target="_blank" style="color: #4A9EFF; text-decoration: underline;">$1</a>');
                            messageDiv.innerHTML = htmlContent;
                        } else {
                            // No URLs, just set as text
                            messageDiv.textContent = item.content;
                        }
                    } else if (item.type === 'file') {
                        // Parse filename and unique filename from content
                        const parts = item.content.split('|');
                        const displayName = parts[0];
                        const uniqueFilename = parts[1] || parts[0]; // fallback for old format

                        // Make file message clickable for download
                        const fileSpan = document.createElement('span');
                        fileSpan.className = 'file-link';
                        fileSpan.textContent = displayName;
                        fileSpan.addEventListener('click', function () {
                            downloadFile(uniqueFilename, displayName);
                        });

                        messageDiv.appendChild(fileSpan);
                    }

                    // Add timestamp
                    const timeDiv = document.createElement('div');
                    timeDiv.className = 'timestamp';
                    const time = new Date(item.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    timeDiv.textContent = `${item.from} â€¢ ${time}`;
                    messageDiv.appendChild(timeDiv);

                    conversation.appendChild(messageDiv);
                });

                // Update the count of displayed messages
                lastMessageCount = data.items.length;

                // Only scroll to bottom if we added new messages
                if (newMessages.length > 0) {
                    setTimeout(() => {
                        conversation.scrollTop = conversation.scrollHeight;
                    }, 10);
                }
            } else {
                // Only show empty state if conversation is truly empty
                if (conversation.children.length === 0) {
                    conversation.innerHTML = '<div class="empty-state">No messages yet</div>';
                }
            }
        }

        function sendMessage() {
            const messageText = inputField.value.trim();
            if (!messageText || isLoading) {
                return;
            }

            console.log('Sending message:', messageText);
            setLoading(true);

            fetch(`${SERVER_URL}/mobile/message`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ text: messageText })
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                }).then(response => {
                    console.log('Message sent successfully:', response);
                    inputField.value = '';
                    updateSendButton();
                    // Keep focus on input to prevent keyboard from hiding
                    // WebSocket will handle the update automatically
                })
                .catch(error => {
                    console.error('Error sending message:', error);
                    displayError('Failed to send message');
                })
                .finally(() => {
                    setLoading(false);
                });
        }

        function sendFile(file) {
            if (isLoading) {
                return;
            }

            console.log('Sending file:', file.name);
            setLoading(true);

            const formData = new FormData();
            formData.append('file', file);

            fetch(`${SERVER_URL}/mobile/file`, {
                method: 'POST',
                body: formData
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(response => {
                    console.log('File sent successfully:', response);
                    fileInput.value = '';
                    // WebSocket will handle the update automatically
                })
                .catch(error => {
                    console.error('Error sending file:', error);
                    displayError('Failed to send file');
                })
                .finally(() => {
                    setLoading(false);
                });
        }

        function downloadFile(uniqueFilename, displayName) {
            console.log('Downloading file:', displayName);

            const downloadUrl = `${SERVER_URL}/uploads/${uniqueFilename}`;

            // Create a temporary link and click it to trigger download
            const a = document.createElement('a');
            a.href = downloadUrl;
            a.download = displayName;
            a.style.display = 'none';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        function setLoading(loading) {
            isLoading = loading;
            updateSendButton();

            if (loading) {
                inputField.disabled = true;
                attachFileButton.disabled = true;
                sendButton.disabled = true;
            } else {
                inputField.disabled = false;
                attachFileButton.disabled = false;
                sendButton.disabled = false;
                // Don't auto-focus after loading to prevent keyboard flicker
            }
        }

        function displayError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'message';
            errorDiv.style.background = '#ff4444';
            errorDiv.style.color = 'white';
            errorDiv.style.margin = '10px auto';
            errorDiv.style.textAlign = 'center';
            errorDiv.innerHTML = message;

            conversation.appendChild(errorDiv);
            conversation.scrollTop = conversation.scrollHeight;

            // Remove error message after 3 seconds
            setTimeout(() => {
                if (errorDiv.parentNode) {
                    errorDiv.parentNode.removeChild(errorDiv);
                }
            }, 3000);
        }

        function formatTimestamp(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function setupEventListeners() {
            // Send button click
            sendButton.addEventListener('click', function () {
                sendMessage();
            });

            // Input field enter key
            inputField.addEventListener('keypress', function (e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            // Input field changes (enable/disable send button)
            inputField.addEventListener('input', function () {
                updateSendButton();
            });

            // Attach file button
            attachFileButton.addEventListener('click', function () {
                fileInput.click();
            });

            // File input change
            fileInput.addEventListener('change', function () {
                if (this.files.length > 0) {
                    console.log('File selected:', this.files[0].name);
                    sendFile(this.files[0]);
                }
            });

            // Prevent zoom on double tap
            document.addEventListener('touchend', function (e) {
                const now = (new Date()).getTime();
                if (now - lastTouchEnd <= 300) {
                    e.preventDefault();
                }
                lastTouchEnd = now;
            }, false);
        }

        let lastTouchEnd = 0;

        function updateSendButton() {
            const hasText = inputField.value.trim().length > 0;
            sendButton.disabled = !hasText || isLoading;

            if (hasText && !isLoading) {
                sendButton.style.opacity = '1';
            } else {
                sendButton.style.opacity = '0.5';
            }
        }

        // Auto-focus input field on page load (mobile-friendly)
        window.addEventListener('load', function () {
            // Small delay to ensure the page is fully loaded
            setTimeout(() => {
                inputField.focus();
            }, 100);
        });
    </script>
</body>

</html>